# üîó –ì–ª–∞–≤–∞ 18: –†–∞–±–æ—Ç–∞ —Å API ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö!

## üéØ –ß—Ç–æ –≤—ã –∏–∑—É—á–∏—Ç–µ

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è —ç—Ç–æ–π –≥–ª–∞–≤—ã –≤—ã —Å–º–æ–∂–µ—Ç–µ:

* **üåê –†–∞–±–æ—Ç–∞—Ç—å —Å REST API** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
* **üîê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é** –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å API –∫–ª—é—á–∞–º–∏  
* **üêç –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Python** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
* **üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã** —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
* **üíæ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å API —Å SQL** –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–∞—Ö
* **üìä –ü—Ä–∏–º–µ–Ω—è—Ç—å API –≤ –±–∏–∑–Ω–µ—Å–µ** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–æ–≤ –∏ –æ—Ç—á–µ—Ç–æ–≤

## üåü API –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏

**API (Application Programming Interface)** ‚Äî —ç—Ç–æ –∫–∞–∫ "–æ—Ñ–∏—Ü–∏–∞–Ω—Ç" –º–µ–∂–¥—É –≤–∞—à–µ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π –∏ —á—É–∂–∏–º —Å–µ—Ä–≤–∏—Å–æ–º. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω:

### üçΩÔ∏è –ú–µ—Ç–∞—Ñ–æ—Ä–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:
* **üë• –í—ã** ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫, –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ
* **üç≥ –ö—É—Ö–Ω—è** ‚Äî —Å–µ—Ä–≤–∏—Å —Å –¥–∞–Ω–Ω—ã–º–∏ (Instagram, –≤–∞–ª—é—Ç–Ω—ã–π —Å–∞–π—Ç, –ø–æ–≥–æ–¥–Ω—ã–π —Å–µ—Ä–≤–∏—Å)  
* **üë®‚Äçüç≥ –ü–æ–≤–∞—Ä** ‚Äî –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞
* **üßæ –ú–µ–Ω—é** ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API (—á—Ç–æ –º–æ–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å)
* **üë®‚Äçüç≥ –û—Ñ–∏—Ü–∏–∞–Ω—Ç** ‚Äî —Å–∞–º–æ API (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–∞—à –∑–∞–∫–∞–∑, –ø—Ä–∏–Ω–æ—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ)
* **üí∞ –ß–µ–∫** ‚Äî API –∫–ª—é—á (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫–∞–∑—ã–≤–∞—Ç—å)

–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–π—Ç–∏ –Ω–∞ –∫—É—Ö–Ω—é –∏ –≤–∑—è—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∞–º–∏ ‚Äî –Ω—É–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞ (API) –ø–æ –º–µ–Ω—é (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏).

### üíº –ó–∞—á–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –Ω—É–∂–Ω—ã API –≤ 2025:

**–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```python
# –í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
current_exchange_rate = api.get_exchange_rate("USD", "RUB")
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º:**
```python
# –°–≤—è–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
crm_clients = salesforce_api.get_clients()
marketing_data = facebook_api.get_campaigns()
financial_data = accounting_api.get_revenue()
```

**–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤:**
```python
# –î–∞—à–±–æ—Ä–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å–∞–º –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ
def morning_report():
    weather = weather_api.get_forecast()
    sales = crm_api.get_yesterday_sales()  
    send_report_to_manager(weather, sales)
```

## üìö –û—Å–Ω–æ–≤—ã —Ä–∞–±–æ—Ç—ã —Å API

### üåê –ß—Ç–æ —Ç–∞–∫–æ–µ REST API

**REST** (Representational State Transfer) ‚Äî —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç API, —Ä–∞–±–æ—Ç–∞—é—â–∏–π —á–µ—Ä–µ–∑ HTTP –∑–∞–ø—Ä–æ—Å—ã.

#### üî§ –û—Å–Ω–æ–≤–Ω—ã–µ HTTP –º–µ—Ç–æ–¥—ã:
* **GET** ‚Äî –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ —Å–ø—Ä–æ—Å–∏—Ç—å "—á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å?")
* **POST** ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑)
* **PUT** ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑)
* **DELETE** ‚Äî —É–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑)

#### üìã –ê–Ω–∞—Ç–æ–º–∏—è API –∑–∞–ø—Ä–æ—Å–∞:

```python
import requests

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞
response = requests.get(
    url="https://api.example.com/v1/users",    # –ê–¥—Ä–µ—Å API
    headers={                                   # –ó–∞–≥–æ–ª–æ–≤–∫–∏
        "Authorization": "Bearer your-token",
        "Content-Type": "application/json"
    },
    params={                                    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞  
        "page": 1,
        "limit": 100,
        "filter": "active"
    }
)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
if response.status_code == 200:
    data = response.json()  # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    print("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
else:
    print(f"‚ùå –û—à–∏–±–∫–∞: {response.status_code}")
```

### üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### üóùÔ∏è –¢–∏–ø—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

**1. API Key (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π):**
```python
headers = {"X-API-Key": "your-secret-key"}
response = requests.get(url, headers=headers)
```

**2. Bearer Token (OAuth):**
```python
headers = {"Authorization": "Bearer eyJhbGciOiJIUzI1NiIs..."}
response = requests.get(url, headers=headers)
```

**3. Basic Authentication:**
```python
from requests.auth import HTTPBasicAuth
response = requests.get(url, auth=HTTPBasicAuth('username', 'password'))
```

#### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API –∫–ª—é—á–µ–π:

**‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –∫–ª—é—á –≤ –∫–æ–¥–µ:**
```python
# –ù–ò–ö–û–ì–î–ê –ù–ï –î–ï–õ–ê–ô–¢–ï –¢–ê–ö!
api_key = "sk-1234567890abcdef"  # –í—Å–µ —É–≤–∏–¥—è—Ç –≤–∞—à –∫–ª—é—á
```

**‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```python
import os
from dotenv import load_dotenv

load_dotenv()  # –ó–∞–≥—Ä—É–∂–∞–µ–º .env —Ñ–∞–π–ª
api_key = os.getenv('API_KEY')  # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ–º –∫–ª—é—á

if not api_key:
    raise ValueError("‚ùå API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")
```

**.env —Ñ–∞–π–ª (–ù–ï –∫–æ–º–º–∏—Ç–∏–º –≤ Git!):**
```
API_KEY=sk-1234567890abcdef
DATABASE_URL=postgresql://user:pass@localhost:5432/db
WEATHER_API_KEY=your-weather-key
```

### üîß Python –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API

#### üì¶ –û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:

**requests ‚Äî –æ—Å–Ω–æ–≤–∞ –≤—Å–µ–≥–æ:**
```python
import requests
import json

# GET –∑–∞–ø—Ä–æ—Å
response = requests.get('https://api.github.com/users/octocat')
user_data = response.json()

# POST –∑–∞–ø—Ä–æ—Å —Å –¥–∞–Ω–Ω—ã–º–∏
payload = {"name": "John", "email": "john@example.com"}
response = requests.post('https://api.example.com/users', json=payload)
```

**requests-cache ‚Äî –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤:**
```python
import requests_cache

# –ö–µ—à–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ 1 —á–∞—Å (—ç–∫–æ–Ω–æ–º–∏–º API –ª–∏–º–∏—Ç—ã)
session = requests_cache.CachedSession(expire_after=3600)
response = session.get('https://api.expensive-service.com/data')
```

**httpx ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**
```python
import httpx
import asyncio

async def get_multiple_apis():
    async with httpx.AsyncClient() as client:
        tasks = [
            client.get('https://api.service1.com/data'),
            client.get('https://api.service2.com/data'),
            client.get('https://api.service3.com/data')
        ]
        responses = await asyncio.gather(*tasks)
    return [r.json() for r in responses]

# –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ 3 API –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!
```

#### üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ API:

```python
def safe_api_request(url, max_retries=3):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π API –∑–∞–ø—Ä–æ—Å —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏"""
    
    for attempt in range(max_retries):
        try:
            response = requests.get(url, timeout=10)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–¥
            if response.status_code == 200:
                return response.json()
            elif response.status_code == 429:  # Rate limit
                wait_time = int(response.headers.get('Retry-After', 60))
                print(f"‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç. –ñ–¥–µ–º {wait_time} —Å–µ–∫—É–Ω–¥...")
                time.sleep(wait_time)
                continue
            elif response.status_code == 401:
                raise ValueError("üîê –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á")
            elif response.status_code == 404:
                raise ValueError("üîç –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            else:
                print(f"‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: {response.status_code}")
                
        except requests.exceptions.Timeout:
            print(f"‚è∞ –¢–∞–π–º–∞—É—Ç –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}")
        except requests.exceptions.RequestException as e:
            print(f"üåê –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}")
            
        if attempt < max_retries - 1:
            time.sleep(2 ** attempt)  # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    
    raise Exception(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")
```

### üìä –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ API –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

#### üå§Ô∏è OpenWeatherMap API (–ø–æ–≥–æ–¥–∞):

```python
import requests
import pandas as pd

def get_weather_data(city, api_key):
    """–ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"""
    
    url = f"http://api.openweathermap.org/data/2.5/weather"
    params = {
        'q': city,
        'appid': api_key,
        'units': 'metric',  # –¶–µ–ª—å—Å–∏–∏
        'lang': 'ru'        # –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
    }
    
    response = requests.get(url, params=params)
    
    if response.status_code == 200:
        data = response.json()
        return {
            'city': data['name'],
            'temperature': data['main']['temp'],
            'humidity': data['main']['humidity'],
            'pressure': data['main']['pressure'],
            'description': data['weather'][0]['description'],
            'wind_speed': data['wind']['speed'],
            'timestamp': pd.Timestamp.now()
        }
    else:
        raise Exception(f"–û—à–∏–±–∫–∞ API: {response.status_code}")

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
weather = get_weather_data("–ú–æ—Å–∫–≤–∞", "your-api-key")
print(f"üå°Ô∏è –í –ú–æ—Å–∫–≤–µ {weather['temperature']}¬∞C, {weather['description']}")
```

#### üí± Exchange Rates API (–≤–∞–ª—é—Ç–Ω—ã–µ –∫—É—Ä—Å—ã):

```python
def get_currency_rates(base_currency="USD"):
    """–ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç"""
    
    url = f"https://api.exchangerate-api.com/v4/latest/{base_currency}"
    
    try:
        response = requests.get(url, timeout=10)
        response.raise_for_status()  # –ë—Ä–æ—Å–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        
        data = response.json()
        
        # –°–æ–∑–¥–∞–µ–º DataFrame –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        rates_df = pd.DataFrame([
            {'currency': currency, 'rate': rate, 'date': data['date']}
            for currency, rate in data['rates'].items()
        ])
        
        return rates_df
        
    except requests.exceptions.RequestException as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç: {e}")
        return None

# –ê–Ω–∞–ª–∏–∑ –∫—É—Ä—Å–æ–≤
rates = get_currency_rates("USD")
print("üí∞ –¢–æ–ø-5 —Å–∞–º—ã—Ö –¥–æ—Ä–æ–≥–∏—Ö –≤–∞–ª—é—Ç –∫ –¥–æ–ª–ª–∞—Ä—É:")
print(rates.nlargest(5, 'rate')[['currency', 'rate']])
```

#### üìä JSONPlaceholder API (—Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ):

```python
def get_user_posts_analysis():
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ API"""
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏—Ö –ø–æ—Å—Ç—ã
    users = requests.get('https://jsonplaceholder.typicode.com/users').json()
    posts = requests.get('https://jsonplaceholder.typicode.com/posts').json()
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DataFrame
    users_df = pd.DataFrame(users)
    posts_df = pd.DataFrame(posts)
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    activity = posts_df.groupby('userId').agg({
        'id': 'count',
        'title': lambda x: x.str.len().mean(),
        'body': lambda x: x.str.len().mean()
    }).round(2)
    
    activity.columns = ['posts_count', 'avg_title_length', 'avg_body_length']
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    result = users_df[['id', 'name', 'email', 'company']].merge(
        activity, left_on='id', right_index=True
    )
    
    return result.sort_values('posts_count', ascending=False)

# –ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
activity_report = get_user_posts_analysis()
print("üìà –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:")
print(activity_report.head())
```

### üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

#### ‚è∞ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á —Å schedule:

```python
import schedule
import time
from datetime import datetime

def daily_data_collection():
    """–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ API"""
    
    print(f"üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö: {datetime.now()}")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        weather_data = get_weather_data("–ú–æ—Å–∫–≤–∞", os.getenv('WEATHER_API_KEY'))
        currency_data = get_currency_rates("USD")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        save_to_database(weather_data, 'weather_daily')
        save_to_database(currency_data, 'currency_rates')
        
        print("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: {e}")
        send_alert_email(f"–û—à–∏–±–∫–∞ –≤ daily_data_collection: {e}")

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
schedule.every().day.at("09:00").do(daily_data_collection)
schedule.every().hour.do(lambda: get_weather_data("–ú–æ—Å–∫–≤–∞", api_key))
schedule.every(30).minutes.do(lambda: get_currency_rates("USD"))

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
print("üöÄ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω!")
while True:
    schedule.run_pending()
    time.sleep(60)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
```

#### üèóÔ∏è –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Å –∫–ª–∞—Å—Å–∞–º–∏:

```python
class APIDataCollector:
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–±–æ—Ä—â–∏–∫ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API"""
    
    def __init__(self, name, base_url, api_key=None):
        self.name = name
        self.base_url = base_url.rstrip('/')
        self.api_key = api_key
        self.session = requests.Session()
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Å—Å–∏–∏
        if api_key:
            self.session.headers.update({'Authorization': f'Bearer {api_key}'})
        
        self.session.headers.update({
            'User-Agent': 'DataAnalyticsBot/1.0',
            'Accept': 'application/json'
        })
        
    def get_data(self, endpoint, params=None, max_retries=3):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–∞–º–∏"""
        
        url = f"{self.base_url}/{endpoint.lstrip('/')}"
        
        for attempt in range(max_retries):
            try:
                response = self.session.get(url, params=params, timeout=30)
                
                if response.status_code == 200:
                    return response.json()
                elif response.status_code == 429:
                    wait_time = int(response.headers.get('Retry-After', 60))
                    print(f"‚è≥ Rate limit. Waiting {wait_time}s...")
                    time.sleep(wait_time)
                else:
                    response.raise_for_status()
                    
            except requests.exceptions.RequestException as e:
                if attempt == max_retries - 1:
                    raise
                print(f"‚ö†Ô∏è Attempt {attempt + 1} failed: {e}")
                time.sleep(2 ** attempt)
    
    def collect_and_save(self, endpoint, table_name, params=None):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î"""
        
        try:
            data = self.get_data(endpoint, params)
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DataFrame
            if isinstance(data, list):
                df = pd.DataFrame(data)
            else:
                df = pd.DataFrame([data])
                
            # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            df['collected_at'] = pd.Timestamp.now()
            df['source'] = self.name
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
            save_to_database(df, table_name)
            
            print(f"‚úÖ {self.name}: {len(df)} –∑–∞–ø–∏—Å–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ {table_name}")
            return df
            
        except Exception as e:
            print(f"‚ùå {self.name} error: {e}")
            raise

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞
weather_collector = APIDataCollector(
    name="OpenWeather",
    base_url="http://api.openweathermap.org/data/2.5",
    api_key=os.getenv('WEATHER_API_KEY')
)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ –≥–æ—Ä–æ–¥–∞–º
cities = ["Moscow", "Saint Petersburg", "Novosibirsk"]
for city in cities:
    weather_collector.collect_and_save(
        endpoint="weather",
        table_name="weather_data",
        params={"q": city, "units": "metric", "lang": "ru"}
    )
```

### üíæ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è API —Å SQL –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

#### üóÑÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ API –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL:

```python
import psycopg2
from sqlalchemy import create_engine
import pandas as pd

def setup_database_connection():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    
    connection_string = os.getenv('DATABASE_URL', 
        'postgresql://username:password@localhost:5432/analytics_db')
    
    engine = create_engine(connection_string)
    return engine

def save_to_database(dataframe, table_name, if_exists='append'):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ DataFrame –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    
    engine = setup_database_connection()
    
    try:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        dataframe.to_sql(
            name=table_name,
            con=engine,
            if_exists=if_exists,  # 'append', 'replace', 'fail'
            index=False,
            method='multi'  # –ë—ã—Å—Ç—Ä–∞—è –≤—Å—Ç–∞–≤–∫–∞
        )
        
        print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(dataframe)} –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É {table_name}")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î: {e}")
        raise
    finally:
        engine.dispose()

def create_api_data_tables():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è API –¥–∞–Ω–Ω—ã—Ö"""
    
    engine = setup_database_connection()
    
    # SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
    tables_sql = """
    -- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    CREATE TABLE IF NOT EXISTS weather_data (
        id SERIAL PRIMARY KEY,
        city VARCHAR(100) NOT NULL,
        temperature DECIMAL(5,2),
        humidity INTEGER,
        pressure DECIMAL(7,2),
        description TEXT,
        wind_speed DECIMAL(5,2),
        collected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        source VARCHAR(50)
    );
    
    -- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –≤–∞–ª—é—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤
    CREATE TABLE IF NOT EXISTS currency_rates (
        id SERIAL PRIMARY KEY,
        currency VARCHAR(10) NOT NULL,
        rate DECIMAL(15,6) NOT NULL,
        base_currency VARCHAR(10) DEFAULT 'USD',
        rate_date DATE,
        collected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        source VARCHAR(50)
    );
    
    -- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    CREATE INDEX IF NOT EXISTS idx_weather_city_date 
    ON weather_data(city, collected_at);
    
    CREATE INDEX IF NOT EXISTS idx_currency_date 
    ON currency_rates(currency, rate_date);
    """
    
    try:
        with engine.connect() as connection:
            connection.execute(tables_sql)
            print("‚úÖ –¢–∞–±–ª–∏—Ü—ã –¥–ª—è API –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω—ã")
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü: {e}")
    finally:
        engine.dispose()

# –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: API ‚Üí –û–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí –ë–î ‚Üí –ê–Ω–∞–ª–∏–∑
def complete_api_workflow():
    """–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã —Å API –¥–∞–Ω–Ω—ã–º–∏"""
    
    # 1. –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
    create_api_data_tables()
    
    # 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API
    weather_data = get_weather_data("–ú–æ—Å–∫–≤–∞", os.getenv('WEATHER_API_KEY'))
    currency_data = get_currency_rates("USD")
    
    # 3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    weather_df = pd.DataFrame([weather_data])
    save_to_database(weather_df, 'weather_data')
    save_to_database(currency_data, 'currency_rates')
    
    # 4. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    engine = setup_database_connection()
    
    analysis_query = """
    SELECT 
        city,
        AVG(temperature) as avg_temp,
        AVG(humidity) as avg_humidity,
        COUNT(*) as measurements_count,
        MAX(collected_at) as last_update
    FROM weather_data 
    WHERE collected_at >= CURRENT_DATE - INTERVAL '7 days'
    GROUP BY city
    ORDER BY avg_temp DESC;
    """
    
    analysis_result = pd.read_sql(analysis_query, engine)
    print("üìä –ê–Ω–∞–ª–∏–∑ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é:")
    print(analysis_result)
    
    engine.dispose()
    return analysis_result
```

### üè¢ –ë–∏–∑–Ω–µ—Å-–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è API

#### üìà –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞ –ø—Ä–æ–¥–∞–∂:

```python
def create_sales_dashboard():
    """–°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ CRM API"""
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö API
    crm_data = get_crm_sales_data()  # –ü—Ä–æ–¥–∞–∂–∏ –∏–∑ CRM
    weather_data = get_weather_data("–ú–æ—Å–∫–≤–∞", weather_api_key)  # –ü–æ–≥–æ–¥–∞
    currency_data = get_currency_rates("USD")  # –í–∞–ª—é—Ç–Ω—ã–µ –∫—É—Ä—Å—ã
    
    # –°–æ–∑–¥–∞–µ–º —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
    dashboard_data = {
        'update_time': datetime.now(),
        'total_sales_today': crm_data['today_sales'],
        'sales_vs_yesterday': crm_data['sales_change_pct'],
        'weather_impact': calculate_weather_impact(weather_data, crm_data),
        'usd_rub_rate': currency_data[currency_data['currency'] == 'RUB']['rate'].iloc[0],
        'top_products': crm_data['top_products'][:5]
    }
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è Power BI –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ BI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    dashboard_df = pd.DataFrame([dashboard_data])
    save_to_database(dashboard_df, 'daily_dashboard')
    
    return dashboard_data

def calculate_weather_impact(weather_data, sales_data):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–ª–∏—è–Ω–∏–µ –ø–æ–≥–æ–¥—ã –Ω–∞ –ø—Ä–æ–¥–∞–∂–∏"""
    
    # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –ø–ª–æ—Ö–∞—è –ø–æ–≥–æ–¥–∞ = –±–æ–ª—å—à–µ –æ–Ω–ª–∞–π–Ω –ø—Ä–æ–¥–∞–∂
    temp = weather_data['temperature']
    
    if temp < 0:
        return "–•–æ–ª–æ–¥: +15% –æ–Ω–ª–∞–π–Ω –ø—Ä–æ–¥–∞–∂"
    elif temp > 25:
        return "–ñ–∞—Ä–∞: +10% –Ω–∞–ø–∏—Ç–∫–æ–≤"
    elif '–¥–æ–∂–¥—å' in weather_data['description'].lower():
        return "–î–æ–∂–¥—å: +20% –¥–æ—Å—Ç–∞–≤–∫–∏"
    else:
        return "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è –ø–æ–≥–æ–¥–∞"
```

#### üîî –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–ª–µ—Ä—Ç–æ–≤:

```python
def monitoring_system():
    """–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤–∞–∂–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ API"""
    
    alerts = []
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞
        rates = get_currency_rates("USD")
        rub_rate = rates[rates['currency'] == 'RUB']['rate'].iloc[0]
        
        if rub_rate > 100:  # –î–æ–ª–ª–∞—Ä –≤—ã—à–µ 100 —Ä—É–±–ª–µ–π
            alerts.append(f"üö® –ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞: {rub_rate:.2f} —Ä—É–± - –∫—Ä–∏—Ç–∏—á–Ω–æ –≤—ã—Å–æ–∫–∏–π!")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≥–æ–¥—É
        weather = get_weather_data("–ú–æ—Å–∫–≤–∞", os.getenv('WEATHER_API_KEY'))
        if weather['temperature'] < -20:
            alerts.append(f"ü•∂ –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π —Ö–æ–ª–æ–¥ –≤ –ú–æ—Å–∫–≤–µ: {weather['temperature']}¬∞C")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–¥–∞–∂–∏ (—É—Å–ª–æ–≤–Ω–æ)
        # sales = get_sales_from_crm_api()
        # if sales['today'] < sales['yesterday'] * 0.7:  # –ü–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ –Ω–∞ 30%
        #     alerts.append("üìâ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂!")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        if alerts:
            send_telegram_alert("\n".join(alerts))
            send_email_alert(alerts)
            
        print(f"‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω. –ê–ª–µ—Ä—Ç–æ–≤: {len(alerts)}")
        
    except Exception as e:
        send_telegram_alert(f"‚ùå –û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {e}")

def send_telegram_alert(message):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram —á–µ—Ä–µ–∑ Bot API"""
    
    bot_token = os.getenv('TELEGRAM_BOT_TOKEN')
    chat_id = os.getenv('TELEGRAM_CHAT_ID')
    
    if bot_token and chat_id:
        url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        
        payload = {
            'chat_id': chat_id,
            'text': message,
            'parse_mode': 'HTML'
        }
        
        try:
            response = requests.post(url, json=payload)
            if response.status_code == 200:
                print("üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {response.status_code}")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ Telegram API: {e}")
```

### ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–∏–º–∏—Ç–æ–≤ API

#### üö¶ Rate Limiting –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏:

```python
import time
from functools import wraps

def rate_limit(max_calls_per_minute=60):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã API –≤—ã–∑–æ–≤–æ–≤"""
    
    min_interval = 60.0 / max_calls_per_minute
    last_called = [0.0]
    
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            elapsed = time.time() - last_called[0]
            left_to_wait = min_interval - elapsed
            
            if left_to_wait > 0:
                time.sleep(left_to_wait)
            
            ret = func(*args, **kwargs)
            last_called[0] = time.time()
            return ret
        return wrapper
    return decorator

class APIRateLimiter:
    """–£–º–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏ API"""
    
    def __init__(self, max_requests_per_minute=60):
        self.max_requests = max_requests_per_minute
        self.requests = []
        
    def wait_if_needed(self):
        now = time.time()
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Å—Ç–∞—Ä—à–µ –º–∏–Ω—É—Ç—ã)
        self.requests = [req_time for req_time in self.requests 
                        if now - req_time < 60]
        
        # –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞, –∂–¥–µ–º
        if len(self.requests) >= self.max_requests:
            sleep_time = 60 - (now - self.requests[0]) + 1
            print(f"‚è≥ –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç API. –ñ–¥–µ–º {sleep_time:.1f} —Å–µ–∫...")
            time.sleep(sleep_time)
            
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
        self.requests.append(now)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ rate limiter
limiter = APIRateLimiter(max_requests_per_minute=100)

@rate_limit(max_calls_per_minute=50)
def get_limited_api_data(endpoint):
    """API –∑–∞–ø—Ä–æ—Å —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    limiter.wait_if_needed()
    return requests.get(endpoint)
```

#### üîß –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫:

```python
def robust_api_call(api_function, *args, max_retries=3, backoff_factor=1, **kwargs):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞–¥–µ–∂–Ω—ã—Ö API –≤—ã–∑–æ–≤–æ–≤"""
    
    last_exception = None
    
    for attempt in range(max_retries):
        try:
            result = api_function(*args, **kwargs)
            
            # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            print(f"‚úÖ API –≤—ã–∑–æ–≤ —É—Å–ø–µ—à–µ–Ω —Å {attempt + 1} –ø–æ–ø—ã—Ç–∫–∏")
            return result
            
        except requests.exceptions.HTTPError as e:
            status_code = e.response.status_code
            
            if status_code == 401:
                print("üîê –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á")
                break  # –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            elif status_code == 404:
                print("üîç –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω")
                break  # –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è 404
            elif status_code == 429:
                retry_after = int(e.response.headers.get('Retry-After', 60))
                print(f"‚è≥ Rate limit. –ñ–¥–µ–º {retry_after} —Å–µ–∫...")
                time.sleep(retry_after)
                continue
            elif status_code >= 500:
                print(f"üîß –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ {status_code}. –ü–æ–≤—Ç–æ—Ä...")
                last_exception = e
            else:
                print(f"‚ùå HTTP –æ—à–∏–±–∫–∞ {status_code}")
                last_exception = e
                
        except requests.exceptions.Timeout as e:
            print(f"‚è∞ –¢–∞–π–º–∞—É—Ç –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}")
            last_exception = e
            
        except requests.exceptions.ConnectionError as e:
            print(f"üåê –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {attempt + 1}")
            last_exception = e
            
        except Exception as e:
            print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
            last_exception = e
        
        # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
        if attempt < max_retries - 1:
            sleep_time = backoff_factor * (2 ** attempt)
            print(f"‚è∏Ô∏è –ñ–¥–µ–º {sleep_time} —Å–µ–∫ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
            time.sleep(sleep_time)
    
    # –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã
    raise Exception(f"‚ùå API –≤—ã–∑–æ–≤ –Ω–µ—É–¥–∞—á–µ–Ω –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫. "
                   f"–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_exception}")

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
def safe_weather_request(city):
    return robust_api_call(
        get_weather_data, 
        city, 
        os.getenv('WEATHER_API_KEY'),
        max_retries=5,
        backoff_factor=2
    )
```

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

#### üî¨ –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è API —Ñ—É–Ω–∫—Ü–∏–π:

```python
import unittest
from unittest.mock import Mock, patch
import json

class TestAPIFunctions(unittest.TestCase):
    """–¢–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç—ã —Å API"""
    
    def setUp(self):
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        self.sample_weather_response = {
            'name': 'Moscow',
            'main': {'temp': 15.5, 'humidity': 65, 'pressure': 1013},
            'weather': [{'description': '—è—Å–Ω–æ'}],
            'wind': {'speed': 3.2}
        }
        
    @patch('requests.get')
    def test_get_weather_data_success(self, mock_get):
        """–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º mock
        mock_response = Mock()
        mock_response.status_code = 200
        mock_response.json.return_value = self.sample_weather_response
        mock_get.return_value = mock_response
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é
        result = get_weather_data("Moscow", "test-api-key")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        self.assertEqual(result['city'], 'Moscow')
        self.assertEqual(result['temperature'], 15.5)
        self.assertIsNotNone(result['timestamp'])
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –±—ã–ª —Å–¥–µ–ª–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        mock_get.assert_called_once()
        args, kwargs = mock_get.call_args
        self.assertIn('q=Moscow', str(kwargs.get('params', '')))
        
    @patch('requests.get')
    def test_get_weather_data_api_error(self, mock_get):
        """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ API"""
        
        mock_response = Mock()
        mock_response.status_code = 404
        mock_get.return_value = mock_response
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        with self.assertRaises(Exception) as context:
            get_weather_data("NonexistentCity", "test-api-key")
        
        self.assertIn("404", str(context.exception))

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
if __name__ == '__main__':
    unittest.main()
```

### üìä –ì–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

#### üöÄ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API –∫–ª–∏–µ–Ω—Ç:

```python
class UniversalAPIClient:
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª—é–±—ã–º–∏ REST API"""
    
    def __init__(self, base_url, api_key=None, auth_type='bearer'):
        self.base_url = base_url.rstrip('/')
        self.api_key = api_key
        self.session = requests.Session()
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
        if api_key:
            if auth_type == 'bearer':
                self.session.headers['Authorization'] = f'Bearer {api_key}'
            elif auth_type == 'api_key':
                self.session.headers['X-API-Key'] = api_key
            elif auth_type == 'query':
                self.default_params = {'api_key': api_key}
        
        self.session.headers.update({
            'User-Agent': 'Python-Analytics-Client/1.0',
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        })
        
        self.rate_limiter = APIRateLimiter(max_requests_per_minute=60)
        
    def request(self, method, endpoint, params=None, data=None, **kwargs):
        """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤"""
        
        self.rate_limiter.wait_if_needed()
        
        url = f"{self.base_url}/{endpoint.lstrip('/')}"
        
        # –î–æ–±–∞–≤–ª—è–µ–º API –∫–ª—é—á –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if hasattr(self, 'default_params'):
            params = {**(params or {}), **self.default_params}
        
        return robust_api_call(
            self.session.request,
            method, url,
            params=params,
            json=data,
            **kwargs
        )
    
    def get(self, endpoint, params=None, **kwargs):
        return self.request('GET', endpoint, params=params, **kwargs)
    
    def post(self, endpoint, data=None, **kwargs):
        return self.request('POST', endpoint, data=data, **kwargs)
    
    def put(self, endpoint, data=None, **kwargs):
        return self.request('PUT', endpoint, data=data, **kwargs)
    
    def delete(self, endpoint, **kwargs):
        return self.request('DELETE', endpoint, **kwargs)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
weather_client = UniversalAPIClient(
    base_url="http://api.openweathermap.org/data/2.5",
    api_key=os.getenv('WEATHER_API_KEY'),
    auth_type='query'
)

weather_data = weather_client.get('weather', params={'q': 'Moscow', 'units': 'metric'})
```

#### üìã –ì–æ—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:

```python
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python daily_api_collection.py
"""

import os
import sys
import logging
from datetime import datetime
import pandas as pd

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('api_collection.log'),
        logging.StreamHandler(sys.stdout)
    ]
)

logger = logging.getLogger(__name__)

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö"""
    
    logger.info("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ API")
    
    collected_data = {}
    errors = []
    
    try:
        # 1. –ü–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        logger.info("üå§Ô∏è –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ...")
        weather_data = collect_weather_data()
        collected_data['weather'] = weather_data
        logger.info(f"‚úÖ –ü–æ–≥–æ–¥–∞: {len(weather_data)} –∑–∞–ø–∏—Å–µ–π")
        
    except Exception as e:
        error_msg = f"‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {e}"
        logger.error(error_msg)
        errors.append(error_msg)
    
    try:
        # 2. –í–∞–ª—é—Ç–Ω—ã–µ –∫—É—Ä—Å—ã
        logger.info("üí± –°–æ–±–∏—Ä–∞–µ–º –≤–∞–ª—é—Ç–Ω—ã–µ –∫—É—Ä—Å—ã...")
        currency_data = collect_currency_data()
        collected_data['currency'] = currency_data
        logger.info(f"‚úÖ –í–∞–ª—é—Ç—ã: {len(currency_data)} –∑–∞–ø–∏—Å–µ–π")
        
    except Exception as e:
        error_msg = f"‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –≤–∞–ª—é—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {e}"
        logger.error(error_msg)
        errors.append(error_msg)
    
    # 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    if collected_data:
        try:
            save_collected_data(collected_data)
            logger.info("üíæ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑—É")
        except Exception as e:
            error_msg = f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {e}"
            logger.error(error_msg)
            errors.append(error_msg)
    
    # 4. –û—Ç—á–µ—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
    if errors:
        logger.warning(f"‚ö†Ô∏è –°–±–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω —Å {len(errors)} –æ—à–∏–±–∫–∞–º–∏")
        send_error_notification(errors)
    else:
        logger.info("üéâ –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
    
    return len(errors) == 0

def collect_weather_data():
    """–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤"""
    
    cities = ["Moscow", "Saint Petersburg", "Novosibirsk", "Yekaterinburg"]
    weather_data = []
    
    for city in cities:
        try:
            data = get_weather_data(city, os.getenv('WEATHER_API_KEY'))
            weather_data.append(data)
            time.sleep(1)  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É –¥–ª—è {city}: {e}")
    
    return weather_data

def collect_currency_data():
    """–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ –≤–∞–ª—é—Ç–Ω—ã—Ö –∫—É—Ä—Å–∞—Ö"""
    
    rates = get_currency_rates("USD")
    
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–∞–ª—é—Ç—ã
    important_currencies = ['RUB', 'EUR', 'GBP', 'JPY', 'CNY']
    filtered_rates = rates[rates['currency'].isin(important_currencies)]
    
    return filtered_rates.to_dict('records')

def save_collected_data(data):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑—É"""
    
    engine = setup_database_connection()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –≤ —Å–≤–æ—é —Ç–∞–±–ª–∏—Ü—É
    for data_type, records in data.items():
        if records:
            df = pd.DataFrame(records)
            df['collection_date'] = datetime.now().date()
            
            save_to_database(df, f'{data_type}_daily')
            logger.info(f"üíæ {data_type}: {len(df)} –∑–∞–ø–∏—Å–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ")

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
```

## üõ† –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–¥–∞–Ω–∏—è–º –∏ –∏–∑—É—á–∏—Ç–µ —Ä–∞–±–æ—Ç—É —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ API:

- üìù [–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –∑–∞–¥–∞–Ω–∏—è–º](practice.md)
- ‚úÖ [–ü–µ—Ä–µ–π—Ç–∏ –∫ —á–µ–∫-–ª–∏—Å—Ç—É](checklist.md)
- üìÅ [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —É—á–µ–±–Ω—ã–µ —Ñ–∞–π–ª—ã](files/README.md)

---

- üîô [–ü—Ä–µ–¥—ã–¥—É—â–∞—è –≥–ª–∞–≤–∞: –ì–ª–∞–≤–∞ 17 - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ä–µ–≥—Ä–µ—Å—Å–∏—è –≤ –º–∞—à–∏–Ω–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏](../chapter-17/README.md)
- üîú [–°–ª–µ–¥—É—é—â–∞—è –≥–ª–∞–≤–∞: –ì–ª–∞–≤–∞ 19 - SQL: –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –∞–≥—Ä–µ–≥–∞—Ç—ã, GROUP BY](../chapter-19/README.md)

---

- üì¢ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —á–∞—Ç—É –∫—É—Ä—Å–∞: https://t.me/analytics_course_chat
- üì¢ –ö–∞–Ω–∞–ª –∫—É—Ä—Å–∞: https://t.me/analytics_course_channel